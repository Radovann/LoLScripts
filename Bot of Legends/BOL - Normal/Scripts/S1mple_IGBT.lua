-- http://bol-tools.com/ tracker
assert(load(Base64Decode("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"), nil, "bt", _ENV))()
TrackerLoad("BWR0YoyZGEK5KSTp")

local version = 0.4
local rainbow_text = false
local rainbow_bg = false

local oldprint = print
local print = function(arg,loglevel)

	if not loglevel then
		loglevel = 1
	end
	
	local color = {
		"#00FF00",
		"#AA1010",
		"#FF1010",
	}
	
	local ll = {
		"Information",
		"Warning",
		"Error",
	}
	oldprint('<font color=\"#808080\">S1mple - IGBT </font><font color=\"'..(color[loglevel] and color[loglevel] or "FF1010")..'\">['..(ll[loglevel] and ll[loglevel] or "")..']</font><font color=\"#515151\"> - </font><font color=\"#FFFFFF\">'..tostring(arg)..'</font>')
end

local function TCPGetRequest(server, path, data, port)
	local start_t = os.clock()
	local port = port or 80
	local data = data or {}
	local lua_socket = require("socket")
	local connection_tcp = lua_socket.connect(server,port)
	local requeststring = "GET "..path
	local first = true
	for i,v in pairs(data)do
		requeststring = requeststring..(first and "?" or "&")..i.."="..v
		first = false
	end
	requeststring = requeststring.. " HTTP/1.0\r\nHost: "..server.."\r\n\r\n"
	connection_tcp:send(requeststring)
	local response = ""
	local status
	while true do
		s,status, partial = connection_tcp:receive('*a')
		response = response..(s or partial)
		if(status == "closed" or status == "timeout")then
			break
		end
	end
	local end_t = os.clock()
	local start_content = response:find("\r\n\r\n")+4
	response = response:sub(start_content)
	return response, status, end_t-start_t
end

local champion_scripts = {}
local champions = {}

AddLoadCallback(function()
	Update()
	
	local UpdateHost = "s1mplescripts.de"
	local ServerPath = "/S1mple/Scripts/BolStudio/s1mple_ingame_bol_tools/"
	local ScriptsPath = "getBufferedScripts.php"
	local ChampionsPath = "getChampionNames.php"
	
	
	local r,s,t = TCPGetRequest(UpdateHost, ServerPath..ScriptsPath)
	cs = load(Base64Decode(r))()
	if type(cs) == "table" then
		champion_scripts = cs
	else
		print("Could not get Champion Scripts List",3)
	end
	
	local r,s,t = TCPGetRequest(UpdateHost, ServerPath..ChampionsPath)
	c = load(r)()
	if type(c) == "table" then
		champions = c
	else
		print("Could not get Champions List",3)
	end
	
	print("Downloaded all tables",1)
	create_champion_buttons()	
	create_champ_script_buttons()
	create_other_buttons()
end)

function Update()
	local UpdateHost = "s1mplescripts.de"
	local ServerPath = "/S1mple/Scripts/BolStudio/s1mple_ingame_bol_tools/"
	local VersionPath = "S1mple_IGBT.version"
	local ScriptPath = "S1mple_IGBT.lua"
	local r,s,t = TCPGetRequest(UpdateHost, ServerPath..VersionPath)
	if r and tonumber(r) and tonumber(r) > version then
		print("Updating from " .. version .. " => " .. r)		
		local r,s,t = TCPGetRequest(UpdateHost, ServerPath..ScriptsPath)
		local f = io.open(FILE_NAME, "wb")
		f:write(r)
		f:close()
		print("Updated, please reload")
	end
end

function GetRainbowColor(row)
	local center = 128
	local width = 127
	local frequency = math.pi*2/10
	local red = math.sin(frequency*row+2)*width+center
	local green = math.sin(frequency*row+0)*width+center
	local blue = math.sin(frequency*row+4)*width+center
	
	return red, green, blue
end


function DrawRainBowText(text, size, x, y, phase)
	phase = phase + GetGameTimer()%10
	local r,g,b = GetRainbowColor(phase)
	DrawTextA(text, size, x, y, ARGB(255,r,g,b))
end

function DrawRainBowRect(x, y, width, height, phase)
	phase = phase + GetGameTimer()%10
	local r,g,b = GetRainbowColor(phase)
	DrawRectangle(x, y, width, height, ARGB(255,r,g,b))
end

local buttons = {}

function create_champion_buttons()
	local start_x = WINDOW_W/4
	local start_y = WINDOW_H/10
	
	local max_y = WINDOW_H*0.8
	
	local current_y = start_y
	local current_x = start_x
	local r = 0
	
	for i=1, #champions do
		local color = ARGB(255,255,255,255)
		if(champions[i] == myHero.charName)then
			color = ARGB(255,255,255,0)
		end
		buttons[#buttons+1] = {
			name = champions[i],
			text_size = 20,
			x = current_x,
			y = current_y,
			c = color,
			callback = function() champion_button_listner(champions[i]) end,
			witdh = 120,
			height = 30,
			_type = "btn_champ",
			visible = false,
			row = r
		}
		current_y = current_y+35
		if(current_y > max_y)then
			current_y = start_y
			current_x = current_x + 150
			r = r+1
		end
		
	end
end

function create_champ_script_buttons()
	local color_free = ARGB(255,0,255,0)
	local color_paid = ARGB(255,255,0,0)
	local color_vip = ARGB(255,255,255,0)
	for i=1, #champions do
		local scripts = champion_scripts[champions[i]]
		
		local start_x = WINDOW_W/4
		local start_y = WINDOW_H/10
		
		local max_y = WINDOW_H*0.8
		
		local current_y = start_y
		local current_x = start_x
		
		local max_text_lenght = 0
		for i2=1, #scripts do
			local current_script = scripts[i2]
			local n = current_script.title .. " (" .. current_script.user .. ")"
			local text_len = n:len()*10
			if (max_text_lenght < text_len) then
				max_text_lenght = text_len
			end
		end
		
			
		for i2=1, #scripts do
			local current_script = scripts[i2]
			
			local n = current_script.title .. " (" .. current_script.user .. ")"
			buttons[#buttons+1] = {
				name = n,
				text_size = 20,
				x = current_x,
				y = current_y,
				c = current_script.isPaid == "1" and color_paid or current_script.type == "VIP" and color_vip or color_free,
				callback = function() download_script(current_script) end,
				witdh = max_text_lenght,
				height = 30,
				_type = "script_"..champions[i],
				visible = false,
			}
			
			current_y = current_y+35
			if(current_y > max_y)then
				current_y = start_y
				current_x = current_x + max_text_lenght+30
			end
		end
		buttons[#buttons+1] = {
			name = "< ---",
			text_size = 20,
			x = current_x,
			y = current_y,
			c = ARGB(255,0,255,255),
			callback = function() back_to_main() end,
			witdh = max_text_lenght,
			height = 30,
			_type = "script_"..champions[i],
			visible = false,
		}
	end
end

function create_other_buttons()
	local start_x = WINDOW_W-130
	local start_y = WINDOW_H/16
	
	local max_y = WINDOW_H*0.8
	
	local current_y = start_y
	local current_x = start_x
	
	
	buttons[#buttons+1] = {
		name = "Open",
		text_size = 20,
		x = current_x,
		y = current_y,
		c = color,
		callback = function() toggle_visibilty(true) end,
		witdh = 120,
		height = 30,
		_type = "btn_open",
		visible = true,
	}
	
	buttons[#buttons+1] = {
		name = "Close",
		text_size = 20,
		x = current_x,
		y = current_y,
		c = color,
		callback = function() toggle_visibilty(false) end,
		witdh = 120,
		height = 30,
		_type = "btn_close",
		visible = false,
	}
	
	buttons[#buttons+1] = {
		name = "Rainbow",
		text_size = 20,
		x = current_x,
		y = current_y+45,
		c = color,
		callback = function() if(rainbow_text)then rainbow_text = false else rainbow_text = true end end,
		witdh = 120,
		height = 30,
		_type = "btn_rainbow_text",
		visible = false,
	}
	
	buttons[#buttons+1] = {
		name = "Rainbow BG",
		text_size = 20,
		x = current_x,
		y = current_y+90,
		c = color,
		callback = function() if(rainbow_bg)then rainbow_bg = false else rainbow_bg = true end end,
		witdh = 120,
		height = 30,
		_type = "btn_rainbow_text",
		visible = false,
	}
	
end

local current_menu = "btn_champ"
function set_button_state(_type, state, no_menu)
	if not no_menu then
		current_menu = _type
	end
	for i=1, #buttons do
		if buttons[i]._type == _type then
			buttons[i].visible = state
		end
	end
end

function back_to_main()
	set_button_state(current_menu, false)
	set_button_state("btn_champ", true)
end

function champion_button_listner(champ_name)
	set_button_state("btn_champ", false)
	set_button_state("script_"..champ_name, true)
end

function toggle_visibilty(bool)
	set_button_state(current_menu, bool)
	if bool == true then
		set_button_state("btn_open", false, true)
		set_button_state("btn_close", true, true)
		set_button_state("btn_rainbow_text", true, true)
	else
		set_button_state("btn_open", true, true)	
		set_button_state("btn_close", false, true)	
		set_button_state("btn_rainbow_text", false, true)	
	end
end

function download_script(tbl)
	local UpdateHost = "s1mplescripts.de"
	local ServerPath = "/S1mple/Scripts/BolStudio/s1mple_ingame_bol_tools/"
	local FilePath = "getGit.php"
	local param = {url = Base64Encode(tbl.updateUrl)}
	
	
	local last_slash = tbl.updateUrl:match('^.*()/');
	local file_name = tbl.updateUrl:sub(last_slash+1)
	
	local r,s,t = TCPGetRequest(UpdateHost, ServerPath..FilePath, param)
	local resp = Base64Decode(r)
	
	if(resp == "" or resp == "error")then
		print("There was an error while downloading, please try another Script or try again",2)
	else
		local f = io.open(SCRIPT_PATH..file_name,"w")
		f:write(resp)
		f:close()
		print("Script downloaded",1)
	end
end

AddDrawCallback(function()
	for i=1, #buttons do
		local current = buttons[i]
		if current.visible then
			if rainbow_bg then
				DrawRainBowRect(current.x, current.y, current.witdh,current.height,current.row and current.row or 1)
			else				
				DrawRectangle(current.x, current.y, current.witdh,current.height, ARGB(255,61,61,61))
			end
			if rainbow_text then
				DrawRainBowText(current.name, current.text_size, current.x+5,current.y+5, current.row and current.row or 1)
			else
				DrawTextA(current.name, current.text_size, current.x+5,current.y+5, current.c)
			end
		end
	end
	
	
end)

local disable_input = false
function HandleButtonCallbacks(a,b)
	if a == 514 and b == 0 then
		disable_input = false
	end
	
	if a == 513 and b == 1 and disable_input == false then
		local mousePoswts = WorldToScreen(mousePos)
		
		for i=1, #buttons do
			local current = buttons[i]
			if current.visible and disable_input == false then
				if(mousePoswts.x > current.x and mousePoswts.x < current.x+current.witdh) then
					if (mousePoswts.y > current.y and mousePoswts.y < current.y+current.height)then
						disable_input = true
						current.callback()
					end
				end
			end
		end
	end
end

AddMsgCallback(function(a,b)
	if a == 512 then return end
	HandleButtonCallbacks(a,b)
end)



