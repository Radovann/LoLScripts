assert(load(Base64Decode("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"), nil, "bt", _ENV))()
TrackerLoad("YqXys0LJJ7Y8zw0c")

local script_version = 0.2

local oldprint = print
local print = function(arg)
	oldprint('<font color=\"#808080\">DangerZones</font><font color=\"#515151\"> - </font><font color=\"#FFFFFF\">'..tostring(arg)..'</font>')
end

local function TCPGetRequest(server, path, data, port)
	local start_t = os.clock()
	local port = port or 80
	local data = data or {}
	local lua_socket = require("socket")
	local connection_tcp = lua_socket.connect(server,port)
	local requeststring = "GET "..path
	local first = true

	for i,v in pairs(data) do
		requeststring = requeststring..(first and "?" or "&")..i.."="..v
		first = false
	end
	
	requeststring = requeststring.. " HTTP/1.0\r\nHost: "..server.."\r\n\r\n"
	connection_tcp:send(requeststring)
	local response = ""
	local status
	while true do
		s,status, partial = connection_tcp:receive('*a')
		response = response..(s or partial)
		if(status == "closed" or status == "timeout")then
			break
		end
	end
	local end_t = os.clock()
	local start_content = response:find("\r\n\r\n")+4
	response = response:sub(start_content)
	return response, status, end_t-start_t
end

local function Update()
	local r,s,t = TCPGetRequest("s1mplescripts.de", "/S1mple/Scripts/BolStudio/DangerZones/version.version")
	if r and tonumber(r) then
		if tonumber(r) > script_version then
			print("Updating")
			local r,s,t = TCPGetRequest("s1mplescripts.de", "/S1mple/Scripts/BolStudio/DangerZones/DangerZone.lua")
			if r then
				local f = io.open(SCRIPT_PATH.._ENV.FILE_NAME,"wb")
				f:write(r)
				f:close()
				print("Updated")
			end
		end
	end
end


local ally_heroes = GetAllyHeroes()
local enemy_heros = GetEnemyHeroes()
local DrawLine3D = DrawLine3D

local function GetTurrets()
	turrets = {}
	for i = 1, objManager.maxObjects do
		local object = objManager:getObject(i)
		if object and object.type == "obj_AI_Turret" and object.health ~= 0 and not object.dead then
			local _r = 950
			if object.name == "Turret_ChaosTurretShrine_A" or object.name == "Turret_OrderTurretShrine_A" then
				_r = 1150
			end
			turrets[#turrets+1] = {x = object.x, y = object.y, z = object.z , team = object.team, range = _r}
		end
	end
	return turrets
end

AddLoadCallback(function()
	Update()
	Menu = scriptConfig("DangerZones", 'DangerZones')
	Menu:addParam("maxcalcdistance", "Max Calc Distance", SCRIPT_PARAM_SLICE, 1200,0,2800,1)
	Menu:addParam("mincalcdistance", "Min Calc Distance", SCRIPT_PARAM_SLICE, 0,0,2800,1)
	Menu:addParam("cellsize", "Cell Size", SCRIPT_PARAM_SLICE, 150,50,300,1)
	Menu:addParam("minlinewidth", "Min Line width Size", SCRIPT_PARAM_SLICE, 1,1,5,1)
	Menu:addParam("maxlinewidth", "Max Line width Size", SCRIPT_PARAM_SLICE, 3,1,5,1)
	Menu:addParam("scalewithdanger", "Scale with Danger Level", SCRIPT_PARAM_ONOFF, true)
	Menu:addParam("checkwalls", "Check Walls", SCRIPT_PARAM_ONOFF, true)
	Menu:addParam("doublewallcheck", "Double Wall Check", SCRIPT_PARAM_ONOFF, true)
	Menu:addParam("onlydangerous", "Only show dangerous", SCRIPT_PARAM_ONOFF, true)
	Menu:addParam("additionalawarenessrange", "Additional Awareness Range", SCRIPT_PARAM_SLICE, 200,0,800,0)
	Menu:addParam("hideincombo", "Hide in Combo Mode", SCRIPT_PARAM_ONOFF, true)
	Menu:addParam("checkminionsundertower", "Check if Minions are under Tower", SCRIPT_PARAM_ONOFF, true)
	
	Menu:addSubMenu("Danger Levels","dl")	
		Menu.dl:addParam("turretenemy", "Enemy Turret", SCRIPT_PARAM_SLICE, 128,0,255,1)
		Menu.dl:addParam("turretenemyminon", "Enemy Turret (With Minions)", SCRIPT_PARAM_SLICE, 70,0,255,1)
		Menu.dl:addParam("turretally", "Ally Turret", SCRIPT_PARAM_SLICE, -128,-255,0,1)
		Menu.dl:addParam("space", "", SCRIPT_PARAM_INFO, "")
		Menu.dl:addParam("fountainenemy", "Enemy Fountain", SCRIPT_PARAM_SLICE, 255,0,255,1)
		Menu.dl:addParam("fountainally", "Ally Fountain", SCRIPT_PARAM_SLICE, -255,-255,0,1)
		Menu.dl:addParam("space", "", SCRIPT_PARAM_INFO, "")		
		Menu.dl:addParam("enemyhero", "Enemy Hero", SCRIPT_PARAM_SLICE, 50,0,255,1)
		Menu.dl:addParam("allyhero", "Ally Hero", SCRIPT_PARAM_SLICE, -50,-255,0,1)
		Menu.dl:addParam("space", "", SCRIPT_PARAM_INFO, "")
		Menu.dl:addParam("inf", "Higher means more dangerous", SCRIPT_PARAM_INFO, "")
		Menu.dl:addParam("inf", "Negativ values will make the Zone more secure", SCRIPT_PARAM_INFO, "")
				
	Menu:addSubMenu("Key Settings", "keys")
		Menu.keys:addParam("combo", "Combo Key", SCRIPT_PARAM_ONKEYDOWN, false, string.byte(" "))
	
	Menu:addParam("space", "", SCRIPT_PARAM_INFO, "")
	Menu:addParam("developer", "Developed by S1mple", SCRIPT_PARAM_INFO, "")
	Menu:addParam("version", "Version: ", SCRIPT_PARAM_INFO, script_version)
	print("Loaded")
end)

local to_draw = {}

local function GetMinions()
	local minions = {}
	for i3=1, objManager.maxObjects do
		local cobj = objManager:getObject(i3)
		if cobj and cobj.valid and cobj.visible and not cobj.dead and cobj.type == 'obj_AI_Minion' and cobj.team == myHero.team then
			minions[#minions+1] = cobj
		end
	end
	return minions
end

AddTickCallback(function()
	to_draw = {}
	if Menu.hideincombo and Menu.keys.combo then return end
	
	local turrets = GetTurrets()
	local minions = GetMinions()
	for i=-Menu.maxcalcdistance, Menu.maxcalcdistance, Menu.cellsize do
		for i2 = -Menu.maxcalcdistance, Menu.maxcalcdistance, Menu.cellsize do
			local point = Vector(myHero.x+i2, myHero.y, myHero.z+i)
			if GetDistance(point) > Menu.mincalcdistance then
				local wtsPoint = WorldToScreen(D3DXVECTOR3(point.x, point.y, point.z))
				if OnScreen(wtsPoint.x, wtsPoint.y) then
					
					local dangerlevel = 0
					--Determain dangerlevel
					
					--Check for turrets
					for i=1, #turrets do
						local current = turrets[i]
						if current then
							if GetDistance(point, current) < current.range then
								if current.team == myHero.team then
									if current.range == 1150 then
										dangerlevel = dangerlevel + Menu.dl.fountainally
									else
										dangerlevel = dangerlevel + Menu.dl.turretally
									end
								else
									if current.range == 1150 then
										dangerlevel = dangerlevel + Menu.dl.fountainenemy									
									else
										if Menu.checkminionsundertower then
											local under_tower = false
											for i=1, #minions do
												if GetDistance(minions[i], current) < 950 then
													under_tower = true
													break
												end
											end
											if under_tower then
												dangerlevel = dangerlevel + Menu.dl.turretenemyminon
											else
												dangerlevel = dangerlevel + Menu.dl.turretenemy
											end
										else
											dangerlevel = dangerlevel + Menu.dl.turretenemy
										end
									end
								end
							end
						end
					end
					
					--Check for heroes
					for i=1, #ally_heroes do
						local current = ally_heroes[i]
						if current and not current.dead and current.visible then
							if GetDistance(point, current) < current.range then
								dangerlevel = dangerlevel + Menu.dl.allyhero
							end
						end
					end
					for i=1, #enemy_heros do
						local current = enemy_heros[i]
						if current and not current.dead and current.visible then
							local dst = GetDistance(point, current)
							if dst < current.range then							
								dangerlevel = dangerlevel + Menu.dl.enemyhero*2
							elseif dst < Menu.additionalawarenessrange then
								dangerlevel = dangerlevel + Menu.dl.enemyhero
							end
						end
					end
					
					--Normalize danger level
					dangerlevel = math.max(0,dangerlevel)
					dangerlevel = math.min(255,dangerlevel)
					
					if (Menu.onlydangerous and dangerlevel > 0) or not Menu.onlydangerous then
						
						local rgb = {r = dangerlevel, g = 255-dangerlevel, b = 0}
						
						local iswall = false
						local iswall_2 = false
						
						if Menu.checkwalls then
							iswall = IsWall(D3DXVECTOR3(point.x, point.y, point.z))
							iswall_2 = IsWall(D3DXVECTOR3(point.x+Menu.cellsize, point.y, point.z))
							if Menu.doublewallcheck then
								if not iswall then
									iswall = IsWall(D3DXVECTOR3(point.x, point.y, point.z+Menu.cellsize))
								end
								if not iswall_2 then
									iswall_2 = IsWall(D3DXVECTOR3(point.x, point.y, point.z))
								end
							end
						end
						
						if not iswall and not iswall_2 then
							to_draw[#to_draw+1] = {dl = dangerlevel, s = {x = point.x, y = point.y, z = point.z}, e = {x = point.x, y = point.y , z = point.z+Menu.cellsize}, argb = ARGB(255,rgb.r,rgb.g,rgb.b)}
							to_draw[#to_draw+1] = {dl = dangerlevel, s = {x = point.x+Menu.cellsize, y = point.y, z = point.z}, e = {x = point.x, y = point.y , z = point.z}, argb = ARGB(255,rgb.r,rgb.g,rgb.b)}
						end
						if i == Menu.maxcalcdistance then
							local iswall = false
							if Menu.checkwalls then
							iswall = IsWall(D3DXVECTOR3(point.x+Menu.cellsize, point.y, point.z+Menu.cellsize))
								if Menu.doublewallcheck then
									if not iswall then
										iswall = IsWall(D3DXVECTOR3(point.x, point.y, point.z+Menu.cellsize))
									end
								end
							end
							if not iswall then
								to_draw[#to_draw+1] = {dl = dangerlevel, s = {x = point.x+Menu.cellsize, y = point.y, z = point.z+Menu.cellsize}, e = {x = point.x, y = point.y , z = point.z+Menu.cellsize}, argb = ARGB(255,rgb.r,rgb.g,rgb.b)}
							end
						end
						if i2== Menu.maxcalcdistance then
							local iswall = false
							if Menu.checkwalls then
								iswall = IsWall(D3DXVECTOR3(point.x+Menu.cellsize, point.y, point.z))
								if Menu.doublewallcheck then
									if not iswall then
										iswall = IsWall(D3DXVECTOR3(point.x+Menu.cellsize, point.y, point.z+Menu.cellsize))
									end
								end
							end
							if not iswall then
								to_draw[#to_draw+1] = {dl = dangerlevel, s = {x = point.x+Menu.cellsize, y = point.y, z = point.z}, e = {x = point.x+Menu.cellsize, y = point.y , z = point.z+Menu.cellsize}, argb = ARGB(255,rgb.r,rgb.g,rgb.b)}
							end
						end
					end
				end
			end
		end
	end
end)

AddDrawCallback(function()
	for i=1, #to_draw do
		local current = to_draw[i]
		if current then
			local s = current.s
			local e = current.e
			local argb = current.argb
			local dangerlevel = current.dl
			local lw = Menu.minlinewidth
			if Menu.scalewithdanger then
				lw = Menu.minlinewidth+Menu.maxlinewidth/255*dangerlevel
			end
			DrawLine3D(s.x, s.y, s.z, e.x, e.y, e.z,lw,argb)
		end
	end
end)